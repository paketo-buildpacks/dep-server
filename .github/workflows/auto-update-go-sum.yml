name: Auto update go.sum files

on:
  push:
    branches:
      - main
    paths:
      - '**.mod'
  workflow_dispatch: { }

jobs:
  auto-update-go-sum:
    name: Auto update go.sum
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Go
        uses: actions/setup-go@v1
        with:
          go-version: 1.16

      - name: Checkout Branch
        uses: paketo-buildpacks/github-config/actions/pull-request/checkout-branch@main
        with:
          branch: automation/actions/update-go-sum

      - name:
        run: |
          cd "${{ github.workspace }}/actions/get-upstream-dependency/entrypoint"
          go mod tidy

          cd "${{ github.workspace }}/actions/list-new-upstream-dependency-versions/entrypoint"
          go mod tidy

          cd "${{ github.workspace }}/pkg/dependency/test/acceptance"
          go mod tidy

      - name: Commit
        id: commit
        uses: paketo-buildpacks/github-config/actions/pull-request/create-commit@main
        with:
          message: "Update go.sum files"
          pathspec: "**/*go.sum"

      - name: Push Branch
        if: ${{ steps.commit.outputs.commit_sha != '' }}
        uses: paketo-buildpacks/github-config/actions/pull-request/push-branch@main
        with:
          branch: automation/actions/update-go-sum

      - name: Open Pull Request
        if: ${{ steps.commit.outputs.commit_sha != '' }}
        uses: paketo-buildpacks/github-config/actions/pull-request/open@main
        with:
          token: ${{ secrets.PAKETO_BOT_GITHUB_TOKEN }}
          title: "Update go.sum files"
          branch: automation/actions/update-go-sum